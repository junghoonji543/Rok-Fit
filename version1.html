<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Push-up Trainer</title>
    <!-- TensorFlow.js ë° MoveNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <style>
        body {
            font-family: 'Suit', sans-serif;
            background-color: #121212;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        
        h1 { margin-bottom: 20px; font-size: 1.5rem; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .btn {
            padding: 10px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; font-size: 0.9rem;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-blue { background-color: #3498db; color: white; }
        .btn-green { background-color: #2ecc71; color: white; }
        .btn-red { background-color: #e74c3c; color: white; }
        .btn-yellow { background-color: #f1c40f; color: #2c3e50; }
        .btn-outline { background: transparent; border: 2px solid #bdc3c7; color: #bdc3c7; display: inline-block; text-align: center;}
        
        input[type=file] { display: none; }

        /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ */
        .container {
            position: relative;
            width: 100%;
            max-width: 640px;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        video { 
            position: absolute; top:0; left:0;
            width: 100%; height: 100%; object-fit: cover; 
        }
        canvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        }

        /* íƒ€ì„ë¼ì¸ (ìŠ¬ë¼ì´ë”) */
        .timeline-box {
            width: 100%; max-width: 640px; margin-top: 10px;
            display: flex; align-items: center; gap: 10px;
        }
        .seek-bar {
            flex-grow: 1; height: 6px; cursor: pointer;
            accent-color: #3498db;
        }
        .time-text { font-family: monospace; font-size: 0.9rem; color: #bdc3c7; width: 45px;}

        /* ìƒíƒœì°½ */
        .status-box {
            display: flex; gap: 10px; margin-top: 20px; width: 100%; max-width: 640px;
        }
        .card {
            background: #2c3e50; padding: 15px; border-radius: 10px;
            flex: 1; text-align: center;
        }
        .val { font-size: 2rem; font-weight: bold; color: #2ecc71; }
        .label { font-size: 0.8rem; color: #bdc3c7; }

        #msg { margin-top: 10px; font-weight: bold; color: #3498db; height: 24px; text-align: center;}
        
        /* ë¡œë”© í™”ë©´ */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; justify-content: center; align-items: center; font-size: 1.5rem; flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading">
        <div>AI ëª¨ë¸ ë¡œë”©ì¤‘...</div>
        <div style="font-size:1rem; color:#aaa; margin-top:10px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</div>
    </div>

    <h1>AI Push-up Trainer</h1>

    <div class="btn-group">
        <button class="btn btn-blue" onclick="startCamera()">ğŸ“· ì¹´ë©”ë¼</button>
        <button class="btn btn-yellow" onclick="loadExample()">â–¶ ì˜ˆì‹œ ì˜ìƒ</button>
        <label for="file-in" class="btn btn-outline">ğŸ“‚ ì—…ë¡œë“œ</label>
        <input type="file" id="file-in" accept="video/*">
    </div>

    <div class="btn-group">
        <button id="btn-record" class="btn btn-green" onclick="toggleRecord()" disabled>âº ë…¹í™” ì‹œì‘</button>
        <button class="btn btn-red" onclick="resetCounter()">â†º ë¦¬ì…‹</button>
    </div>

    <div class="container">
        <video id="video" playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <!-- íƒ€ì„ë¼ì¸ ìŠ¬ë¼ì´ë” -->
    <div class="timeline-box">
        <span id="curr-time" class="time-text">0:00</span>
        <input type="range" id="seek-bar" class="seek-bar" min="0" value="0" step="0.1">
        <span id="dur-time" class="time-text">0:00</span>
    </div>

    <div id="msg">ì¹´ë©”ë¼ë¥¼ ì¼œê±°ë‚˜ ì˜ˆì‹œ/ì—…ë¡œë“œ ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.</div>

    <div class="status-box">
        <div class="card">
            <div class="label">COUNT</div>
            <div class="val" id="count-val">0</div>
        </div>
        <div class="card">
            <div class="label">ANGLE</div>
            <div class="val" id="angle-val" style="color:#f1c40f">0Â°</div>
        </div>
        <div class="card">
            <div class="label">STATUS</div>
            <div class="val" id="status-val" style="font-size:1.2rem; line-height: 2.2rem;">Ready</div>
        </div>
    </div>

    <a id="download-link" style="display:none"></a>

<script>
    let detector;
    let video, canvas, ctx;
    let seekBar, currTimeText, durTimeText;
    let rafId;

    // ë¡œì§ ë³€ìˆ˜
    let count = 0;
    let dir = 0; // 0: Down ëŒ€ê¸°, 1: Up ëŒ€ê¸°
    const DOWN_ANGLE = 90; 
    const UP_ANGLE = 160;

    // ë…¹í™” ë³€ìˆ˜
    let mediaRecorder;
    let recordedChunks = [];
    let isRecording = false;
    const btnRecord = document.getElementById('btn-record');

    async function init() {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');
        seekBar = document.getElementById('seek-bar');
        currTimeText = document.getElementById('curr-time');
        durTimeText = document.getElementById('dur-time');

        // ëª¨ë¸ ë¡œë“œ
        const model = poseDetection.SupportedModels.MoveNet;
        const detectorConfig = { modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING };
        detector = await poseDetection.createDetector(model, detectorConfig);

        document.getElementById('loading').style.display = 'none';

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: íŒŒì¼ ì—…ë¡œë“œ
        document.getElementById('file-in').addEventListener('change', handleFile);

        // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ (ê¸¸ì´, ì‚¬ì´ì¦ˆ)
        video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            if(video.videoWidth > 0) {
                video.parentElement.style.aspectRatio = `${video.videoWidth}/${video.videoHeight}`;
            }
            seekBar.max = video.duration;
            durTimeText.innerText = formatTime(video.duration);
            
            // ì˜ìƒì´ ë¡œë“œë˜ë©´ ìë™ ì¬ìƒ
            video.play();
            resetCounter();
            detectLoop();
        });

        // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œê°„ ì—…ë°ì´íŠ¸ (ìŠ¬ë¼ì´ë” ì´ë™)
        video.addEventListener('timeupdate', () => {
            if (!isNaN(video.currentTime)) {
                seekBar.value = video.currentTime;
                currTimeText.innerText = formatTime(video.currentTime);
            }
        });

        // ë¹„ë””ì˜¤ ëë‚¨
        video.addEventListener('ended', () => {
            if (isRecording) stopRecording();
            cancelAnimationFrame(rafId);
        });

        // ìŠ¬ë¼ì´ë” ì¡°ì‘ (Seek)
        seekBar.addEventListener('input', () => {
            video.currentTime = seekBar.value;
            currTimeText.innerText = formatTime(video.currentTime);
            
            // ì¼ì‹œì •ì§€ ìƒíƒœì—¬ë„ ìŠ¬ë¼ì´ë” ì›€ì§ì´ë©´ ë¶„ì„ 1íšŒ ì‹¤í–‰ (ìŠ¤ì¼ˆë ˆí†¤ ë³´ì´ê¸° ìœ„í•¨)
            if (video.paused) {
                predictAndDraw(); 
            }
        });
    }

    // --- ê¸°ëŠ¥ë³„ í•¨ìˆ˜ ---

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const ss = Math.floor(s % 60);
        return `${m}:${ss < 10 ? '0' : ''}${ss}`;
    }

    async function startCamera() {
        if (rafId) cancelAnimationFrame(rafId);
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment', width: 640, height: 480 }, audio: false 
            });
            video.srcObject = stream;
            // ì¹´ë©”ë¼ëŠ” durationì´ ë¬´í•œëŒ€ì´ë¯€ë¡œ ìŠ¬ë¼ì´ë” ë¹„í™œì„±í™”
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                video.play();
                seekBar.disabled = true;
                detectLoop();
            };
            document.getElementById('msg').innerText = "ì¹´ë©”ë¼ ì‹¤í–‰ ì¤‘";
            btnRecord.disabled = false;
            resetCounter();
        } catch (err) {
            alert("ì¹´ë©”ë¼ ì‹¤íŒ¨: " + err.message);
        }
    }

    function handleFile(e) {
        if (rafId) cancelAnimationFrame(rafId);
        const file = e.target.files[0];
        if(!file) return;
        
        loadVideoSource(URL.createObjectURL(file));
    }

    function loadExample() {
        if (rafId) cancelAnimationFrame(rafId);
        // GitHubì— ì˜¬ë¦´ ë•Œ ê°™ì€ í´ë”ì— example.mp4ê°€ ìˆì–´ì•¼ í•¨
        loadVideoSource('./example.mp4'); 
    }

    function loadVideoSource(src) {
        // ê¸°ì¡´ ìŠ¤íŠ¸ë¦¼ í•´ì œ
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        video.src = src;
        seekBar.disabled = false;
        btnRecord.disabled = false;
        document.getElementById('msg').innerText = "ì˜ìƒ ë¶„ì„ ì¤‘";
    }

    // --- AI ë£¨í”„ ---
    async function detectLoop() {
        if (!detector) return;

        // ë¹„ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì´ê±°ë‚˜, ë¡œë“œëœ ìƒíƒœë©´ ê³„ì† ë¶„ì„
        if (!video.paused && !video.ended) {
            await predictAndDraw();
            rafId = requestAnimationFrame(detectLoop);
        }
    }

    // í•œ í”„ë ˆì„ ë¶„ì„ ë° ê·¸ë¦¬ê¸° (ìŠ¬ë¼ì´ë” ì¡°ì‘ì‹œì—ë„ í˜¸ì¶œë¨)
    async function predictAndDraw() {
        if(video.readyState < 2) return; // ë°ì´í„° ë¶€ì¡± ì‹œ íŒ¨ìŠ¤

        const poses = await detector.estimatePoses(video);
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ë…¹í™” ì¤‘ì¼ ë•ŒëŠ” ì›ë³¸ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ ë°”ë‹¥ì— ê·¸ë ¤ì¤˜ì•¼ í•¨
        if (isRecording) {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        }

        if (poses.length > 0) {
            const kps = poses[0].keypoints;
            processPose(kps);
        }
    }

    function processPose(kps) {
        // 5:L_Shoulder, 7:L_Elbow, 9:L_Wrist / 6:R_Shoulder, 8:R_Elbow, 10:R_Wrist
        const leftScore = (kps[5].score + kps[7].score + kps[9].score) / 3;
        const rightScore = (kps[6].score + kps[8].score + kps[10].score) / 3;
        
        const isLeft = leftScore > rightScore;
        const s = isLeft ? kps[5] : kps[6];
        const e = isLeft ? kps[7] : kps[8];
        const w = isLeft ? kps[9] : kps[10];

        if (s.score < 0.3 || e.score < 0.3 || w.score < 0.3) return;

        const angle = calculateAngle(s, e, w);
        
        document.getElementById('angle-val').innerText = Math.round(angle) + "Â°";

        // ì¹´ìš´íŠ¸ ë¡œì§
        if (angle <= DOWN_ANGLE) {
            if (dir === 0) {
                dir = 1;
                document.getElementById('status-val').innerText = "â–¼ Down";
                document.getElementById('status-val').style.color = "#e74c3c";
            }
        }
        if (angle >= UP_ANGLE) {
            if (dir === 1) {
                count++;
                dir = 0;
                document.getElementById('count-val').innerText = count;
                document.getElementById('status-val').innerText = "â–² Up";
                document.getElementById('status-val').style.color = "#2ecc71";
            }
        }

        drawSkeleton(s, e, w, angle);
    }

    function calculateAngle(a, b, c) {
        const rad = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let ang = Math.abs(rad * 180.0 / Math.PI);
        if (ang > 180.0) ang = 360 - ang;
        return ang;
    }

    function drawSkeleton(s, e, w, angle) {
        const color = (angle <= DOWN_ANGLE) ? '#00ff00' : '#3498db';
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = color;
        ctx.beginPath();
        ctx.moveTo(s.x, s.y);
        ctx.lineTo(e.x, e.y);
        ctx.lineTo(w.x, w.y);
        ctx.stroke();

        ctx.fillStyle = 'white';
        [s, e, w].forEach(p => {
            ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, 2*Math.PI); ctx.fill();
        });
    }

    function resetCounter() {
        count = 0;
        dir = 0;
        document.getElementById('count-val').innerText = 0;
        document.getElementById('angle-val').innerText = "0Â°";
        document.getElementById('status-val').innerText = "Ready";
    }

    // --- ë…¹í™” ê¸°ëŠ¥ ---
    function toggleRecord() {
        if (!isRecording) startRecording();
        else stopRecording();
    }

    function startRecording() {
        const stream = canvas.captureStream(30);
        const options = { mimeType: 'video/webm; codecs=vp9' };
        if (!MediaRecorder.isTypeSupported(options.mimeType)) options.mimeType = 'video/webm';

        mediaRecorder = new MediaRecorder(stream, options);
        recordedChunks = [];
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = exportVideo;
        mediaRecorder.start();
        isRecording = true;
        
        btnRecord.innerHTML = "â¹ ë…¹í™” ì¤‘ì§€";
        btnRecord.classList.replace('btn-green', 'btn-red');
        document.getElementById('msg').innerText = "ğŸ”´ ë…¹í™” ì¤‘...";
    }

    function stopRecording() {
        if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        isRecording = false;
        btnRecord.innerHTML = "âº ë…¹í™” ì‹œì‘";
        btnRecord.classList.replace('btn-red', 'btn-green');
    }

    function exportVideo() {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.getElementById('download-link');
        a.href = url;
        a.download = `pushup_${Date.now()}.webm`;
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('msg').innerText = "ë…¹í™” ì €ì¥ ì™„ë£Œ";
    }

    init();
</script>
</body>
</html>
